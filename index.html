<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>GMç”»é¢ï¼ˆé †ä½åˆ¤å®šï¼‰</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body{font-family:sans-serif;text-align:center;padding:10px;background:#eee;touch-action:manipulation}
        .box{background:#fff;padding:15px;border-radius:10px;margin-bottom:15px;box-shadow:0 4px 10px rgba(0,0,0,0.1)}
        h2{margin:0;color:#555;font-size:1em}
        
        /* é †ä½ãƒªã‚¹ãƒˆã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        #ranking-list { text-align: left; padding: 10px; min-height: 50px; }
        .rank-item { padding: 10px; border-bottom: 1px solid #eee; font-size: 1.2em; color: #888; }
        .rank-item.active { background: #ffe6e6; color: #000; font-weight: bold; border: 2px solid #ff3333; border-radius: 5px; }
        .rank-item.ng { text-decoration: line-through; color: #ccc; }
        .rank-badge { display:inline-block; width:30px; font-weight:bold; }
        
        /* ãƒœã‚¿ãƒ³ */
        button{font-size:1.2em;padding:15px;margin:5px;width:95%;max-width:400px;border-radius:10px;border:none;cursor:pointer;color:white;font-weight:bold}
        #judge-area { display: none; margin-top: 10px; border-top: 2px dashed #ddd; padding-top: 10px; }
        #btn-ok{background:#ff3333; width:45%; display:inline-block; font-size:1.5em;}
        #btn-ng{background:#3366ff; width:45%; display:inline-block; font-size:1.5em;}
        #start{background:#ff9900;box-shadow:0 5px #cc7a00}
        #reset{background:#666;box-shadow:0 5px #444}
        button:active{transform:translateY(4px);box-shadow:none !important;}
        
        .status-lamp{display:inline-block;width:15px;height:15px;border-radius:50%;background:#ccc;margin-right:5px}
    </style>
</head>
<body>
    <div class="box">
        <h2>æ—©æŠ¼ã—é †ä½</h2>
        <div id="ranking-list">
            <div style="text-align:center;color:#ccc">å¾…æ©Ÿä¸­...</div>
        </div>

        <!-- åˆ¤å®šã‚¨ãƒªã‚¢ -->
        <div id="judge-area">
            <button id="btn-ok">â­•ï¸ æ­£è§£</button>
            <button id="btn-ng">âŒ ä¸æ­£è§£</button>
            <div style="font-size:0.8em;color:#666;margin-top:5px">â€»ä¸æ­£è§£ã‚’æŠ¼ã™ã¨æ¬¡ã®äººã«æ¨©é™ãŒç§»ã‚Šã¾ã™</div>
        </div>
    </div>

    <button id="start">æ¬¡ã®å•é¡Œã¸ï¼ˆãƒªã‚»ãƒƒãƒˆï¼†é–‹å§‹ï¼‰</button>
    <br>
    <button id="reset">å¼·åˆ¶ãƒªã‚»ãƒƒãƒˆ</button>

    <div style="margin-top:20px;color:#888;font-size:0.8em">
        <span id="lamp" class="status-lamp"></span>æ¥ç¶š: <span id="conn-status">...</span>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // è¨­å®šã‚³ãƒ¼ãƒ‰ï¼ˆã‚ãªãŸã®Configï¼‰
        const firebaseConfig = {
            apiKey: "AIzaSyDGQBFnST2VjMmizssGall_Hk-mDXuwXis",
            authDomain: "hayaoshi--momo.firebaseapp.com",
            projectId: "hayaoshi--momo",
            storageBucket: "hayaoshi--momo.firebasestorage.app",
            messagingSenderId: "178861367734",
            appId: "1:178861367734:web:a3445a7c9d7e1757ede117"
        };

        try { if (!firebase.apps.length) firebase.initializeApp(firebaseConfig); } catch (e) {}

        const db = firebase.database();
        const ref = db.ref('quiz_room');
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // åŠ¹æœéŸ³
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === 'ping') { // æ—©æŠ¼ã—éŸ³
                osc.type = 'sine'; osc.frequency.setValueAtTime(880, now); osc.frequency.setValueAtTime(1760, now+0.1);
                gain.gain.setValueAtTime(0.5, now); gain.gain.exponentialRampToValueAtTime(0.01, now+0.5);
                osc.start(); osc.stop(now+0.5);
            } else if (type === 'ok') { // æ­£è§£
                osc.type = 'triangle'; osc.frequency.setValueAtTime(1320, now); osc.frequency.setValueAtTime(1320, now+0.2);
                gain.gain.setValueAtTime(0.5, now); gain.gain.setValueAtTime(0, now+0.15); gain.gain.setValueAtTime(0.5, now+0.2); gain.gain.exponentialRampToValueAtTime(0.01, now+0.6);
                osc.start(); osc.stop(now+0.6);
            } else if (type === 'ng') { // ä¸æ­£è§£
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(100, now+0.4);
                gain.gain.setValueAtTime(0.5, now); gain.gain.linearRampToValueAtTime(0.01, now+0.4);
                osc.start(); osc.stop(now+0.4);
            }
        }

        let currentQueue = [];
        let currentIndex = 0;

        // ç›£è¦–ã¨è¡¨ç¤ºæ›´æ–°
        ref.on('value', (snapshot) => {
            const data = snapshot.val() || {};
            const queue = data.queue || []; // é…åˆ—ã¨ã—ã¦å–å¾—
            const idx = data.current_index || 0;
            currentQueue = queue;
            currentIndex = idx;
            
            const listDiv = document.getElementById('ranking-list');
            const judgeArea = document.getElementById('judge-area');

            // ãƒªã‚¹ãƒˆè¡¨ç¤ºã®ä½œæˆ
            if (queue.length === 0) {
                listDiv.innerHTML = '<div style="text-align:center;color:#ccc">å¾…æ©Ÿä¸­...</div>';
                judgeArea.style.display = 'none';
            } else {
                let html = '';
                queue.forEach((name, i) => {
                    let className = 'rank-item';
                    let status = '';
                    // ç¾åœ¨ã®å›ç­”æ¨©ãŒã‚ã‚‹äºº
                    if (i === idx) {
                        className += ' active';
                        status = ' ğŸ¤å›ç­”ä¸­';
                    }
                    // æ—¢ã«çµ‚ã‚ã£ãŸäººï¼ˆä¸æ­£è§£ï¼‰
                    if (i < idx) {
                        className += ' ng';
                        status = ' (âŒ)';
                    }
                    html += `<div class="${className}"><span class="rank-badge">${i+1}ç€</span> ${name}${status}</div>`;
                });
                listDiv.innerHTML = html;
                
                // ã¾ã å›ç­”æ¨©ãŒã‚ã‚‹äººãŒæ®‹ã£ã¦ã„ã‚Œã°åˆ¤å®šãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                if (idx < queue.length) {
                    judgeArea.style.display = 'block';
                } else {
                    judgeArea.style.display = 'none'; // å…¨å“¡ä¸æ­£è§£ãªã©ã§çµ‚äº†
                }
            }
            
            // éŸ³ã‚’é³´ã‚‰ã™ï¼ˆæ–°ã—ã„äººãŒå¢—ãˆãŸæ™‚ã ã‘ï¼‰
            // â€»ç°¡æ˜“å®Ÿè£…ã®ãŸã‚ã€ã“ã“ã§ã¯ãƒªã‚¹ãƒˆãŒå¢—ãˆãŸã‚‰é³´ã‚‰ã™
            if (window.lastLen && queue.length > window.lastLen) playSound('ping');
            window.lastLen = queue.length;
        });

        // â­•ï¸ æ­£è§£
        document.getElementById('btn-ok').addEventListener('click', () => {
            playSound('ok');
            ref.update({ judgment: 'correct' });
            // æ­£è§£ã—ãŸã‚‰ãã®ã¾ã¾ã§OKï¼ˆæ¬¡ã®å•é¡Œã¸é€²ã‚€ã®ã¯GMã®æ‰‹å‹•ï¼‰
        });

        // âŒ ä¸æ­£è§£ï¼ˆè‡ªå‹•ç¹°ã‚Šä¸Šã’ï¼‰
        document.getElementById('btn-ng').addEventListener('click', () => {
            playSound('ng');
            
            // 1. ã¾ãšã€Œä¸æ­£è§£ã€çŠ¶æ…‹ã‚’è¡¨ç¤º
            ref.update({ judgment: 'incorrect' });
            
            // 2. 1.5ç§’å¾Œã«æ¬¡ã®äººã¸æ¨©é™ã‚’ç§»ã™
            setTimeout(() => {
                ref.transaction((data) => {
                    if (data) {
                        data.judgment = null; // åˆ¤å®šãƒªã‚»ãƒƒãƒˆ
                        data.current_index = (data.current_index || 0) + 1; // æ¬¡ã®äººã¸
                    }
                    return data;
                });
            }, 1500);
        });

        // ã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆãƒªã‚»ãƒƒãƒˆã—ã¦é–‹å§‹ï¼‰
        document.getElementById('start').addEventListener('click', () => {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            window.lastLen = 0;
            ref.set({
                state: 'open',
                queue: [],
                current_index: 0,
                judgment: null
            });
        });

        // æ¥ç¶šç¢ºèª
        db.ref(".info/connected").on("value", (snap) => {
            const lamp = document.getElementById('lamp');
            if(snap.val()) { lamp.style.background = "#4CAF50"; document.getElementById('conn-status').innerText = "OK"; }
            else { lamp.style.background = "#ccc"; document.getElementById('conn-status').innerText = "æœªæ¥ç¶š"; }
        });
    </script>
</body>
</html>