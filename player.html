<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>早押しボタン</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        body{font-family:sans-serif;text-align:center;padding:20px;touch-action:manipulation;background:#fff0f5}
        input{font-size:1.2em;padding:10px;width:80%;margin-bottom:20px;border:1px solid #ccc;border-radius:5px;}
        button{cursor:pointer;font-family:inherit;}
        #login-screen{margin-top:50px;}
        #game-screen{display:none;}
        
        #btn{
            width: 80vw; height: 80vw; max-width: 300px; max-height: 300px;
            border-radius: 50%; border: none;
            font-size: 2em; color: white;
            background: #ccc;
            box-shadow: 0 8px #999;
            transition: all 0.1s;
        }
        /* 有効時（ピンク） */
        #btn.active{ background: #ff66b2 !important; box-shadow: 0 8px #cc338b !important; }
        #btn:active{ transform:translateY(4px); box-shadow: 0 4px #999; }
        
        #status{margin-top:20px;font-weight:bold;font-size:1.8em;min-height:1.5em;color:#555}
        #rank-info{margin-top:10px;font-size:1.2em;color:#888;}
    </style>
</head>
<body>
    <div id="login-screen">
        <h2 style="color:#ff66b2">チーム名を入力</h2>
        <input type="text" id="team-name" placeholder="例：チームA">
        <br>
        <button onclick="joinGame()" style="font-size:1.2em;padding:12px 30px;background:#333;color:white;border:none;border-radius:5px;">参加する</button>
    </div>

    <div id="game-screen">
        <h3 id="display-name" style="color:#555"></h3>
        <button id="btn" disabled>待機</button>
        <div id="status"></div>
        <div id="rank-info"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDGQBFnST2VjMmizssGall_Hk-mDXuwXis",
            authDomain: "hayaoshi--momo.firebaseapp.com",
            projectId: "hayaoshi--momo",
            storageBucket: "hayaoshi--momo.firebasestorage.app",
            messagingSenderId: "178861367734",
            appId: "1:178861367734:web:a3445a7c9d7e1757ede117"
        };

        try { if (!firebase.apps.length) firebase.initializeApp(firebaseConfig); } catch (e) {}

        const db = firebase.database();
        const ref = db.ref('quiz_room');
        let myName = "";

        function joinGame() {
            const input = document.getElementById('team-name');
            if (!input.value) return alert("名前を入れてください");
            myName = input.value;
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';
            document.getElementById('display-name').innerText = myName;
        }

        const btn = document.getElementById('btn');
        const status = document.getElementById('status');
        const rankInfo = document.getElementById('rank-info');

        ref.on('value', (snapshot) => {
            const data = snapshot.val() || {};
            const state = data.state || 'closed';
            const queue = data.queue || []; // 順位リスト
            const idx = data.current_index || 0; // いま誰の番か
            const judgment = data.judgment;

            // 自分がリストのどこにいるか探す（-1なら居ない）
            const myRankIndex = queue.indexOf(myName);
            const amIInQueue = myRankIndex !== -1;

            // --- 状態ごとの表示切り替え ---

            // 1. 早押し受付中（まだ自分が押していない時）
            if (state === 'open' && !amIInQueue) {
                btn.disabled = false;
                btn.className = 'active';
                btn.style.background = "#ff66b2"; 
                btn.innerText = "PUSH!";
                status.innerText = "";
                rankInfo.innerText = "";
            } 
            // 2. 誰かが押したあと（または自分が押した後）
            else {
                btn.disabled = true;
                btn.className = '';
                
                if (amIInQueue) {
                    // 自分はリストに入っている（押せた！）
                    if (myRankIndex === idx) {
                        // ★★★ 今、自分の番！ ★★★
                        if (judgment === 'correct') {
                            btn.style.background = "#ffcc00"; btn.innerText = "⭕️";
                            status.style.color = "#e6ac00"; status.innerText = "正解！！";
                            rankInfo.innerText = "";
                        } else if (judgment === 'incorrect') {
                            btn.style.background = "#3366ff"; btn.innerText = "❌";
                            status.style.color = "#3366ff"; status.innerText = "不正解...";
                            rankInfo.innerText = "";
                        } else {
                            btn.style.background = "#ff3333"; btn.innerText = "YOU";
                            status.style.color = "#ff3333"; status.innerText = "回答権獲得！";
                            rankInfo.innerText = "あなたが回答者です";
                        }
                    } else if (myRankIndex > idx) {
                        // 自分の番はまだ来ていない（2着以降）
                        btn.style.background = "#ccc"; btn.innerText = (myRankIndex + 1) + "着";
                        status.style.color = "black"; status.innerText = "待機中...";
                        rankInfo.innerText = `あなたは ${myRankIndex + 1}番目 です`;
                    } else {
                        // 自分の番はもう終わった（不正解で流れた後）
                        btn.style.background = "#888"; btn.innerText = "❌";
                        status.style.color = "#888"; status.innerText = "終了";
                        rankInfo.innerText = "";
                    }
                } else {
                    // 自分は押せなかった（リスト外）
                    btn.style.background = "#ccc"; btn.innerText = "LOCK";
                    status.style.color = "black"; status.innerText = queue.length > 0 ? "他の人が回答中" : "待機";
                    rankInfo.innerText = "";
                }
            }
        });

        // ボタンを押した時の処理（リストへの追加）
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            ref.child('queue').transaction((currentQueue) => {
                if (currentQueue === null) return [myName]; // 最初の一人
                if (currentQueue.includes(myName)) return;  // 既に登録済みなら何もしない
                return [...currentQueue, myName]; // 末尾に追加
            });
        });
    </script>
</body>
</html>