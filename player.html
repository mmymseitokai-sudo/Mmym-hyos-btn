<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>早押しボタン</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        body{font-family:sans-serif;text-align:center;padding:20px;touch-action:manipulation;background:#fff0f5}
        input{font-size:1.2em;padding:10px;width:80%;margin-bottom:20px;border:1px solid #ccc;border-radius:5px;}
        button{cursor:pointer;font-family:inherit;}
        #login-screen{margin-top:50px;}
        #game-screen{display:none;}
        
        #btn{
            width: 80vw; height: 80vw;
            max-width: 300px; max-height: 300px;
            border-radius: 50%; border: none;
            font-size: 2em; color: white;
            background: #ccc;
            box-shadow: 0 8px #999;
            transition: all 0.1s;
        }
        /* 有効時（ピンク） */
        #btn.active{
            background: #ff66b2 !important;
            box-shadow: 0 8px #cc338b !important;
        }
        #btn:active{ transform:translateY(4px); box-shadow: 0 4px #999; }
        
        #status{margin-top:20px;font-weight:bold;font-size:2em;min-height:1.5em;color:#555}
    </style>
</head>
<body>
    <div id="login-screen">
        <h2 style="color:#ff66b2">チーム名を入力</h2>
        <input type="text" id="team-name" placeholder="例：チームA">
        <br>
        <button onclick="joinGame()" style="font-size:1.2em;padding:12px 30px;background:#333;color:white;border:none;border-radius:5px;">参加する</button>
    </div>

    <div id="game-screen">
        <h3 id="display-name" style="color:#555"></h3>
        <button id="btn" disabled>待機</button>
        <div id="status"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDGQBFnST2VjMmizssGall_Hk-mDXuwXis",
            authDomain: "hayaoshi--momo.firebaseapp.com",
            projectId: "hayaoshi--momo",
            storageBucket: "hayaoshi--momo.firebasestorage.app",
            messagingSenderId: "178861367734",
            appId: "1:178861367734:web:a3445a7c9d7e1757ede117"
        };

        try {
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        } catch (e) {}

        const db = firebase.database();
        const ref = db.ref('quiz_room');
        let myName = "";

        function joinGame() {
            const input = document.getElementById('team-name');
            if (!input.value) return alert("名前を入れてください");
            myName = input.value;
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';
            document.getElementById('display-name').innerText = myName;
        }

        const btn = document.getElementById('btn');
        const status = document.getElementById('status');

        ref.on('value', (snapshot) => {
            const data = snapshot.val() || {};
            const state = data.state || 'closed';
            const winner = data.winner;
            const judgment = data.judgment; // 判定結果（correct, incorrect, null）

            // 1. 早押し受付中
            if (state === 'open' && !winner) {
                btn.disabled = false;
                btn.className = 'active';
                btn.style.background = "#ff66b2"; 
                btn.innerText = "PUSH!";
                status.innerText = "";
            } 
            // 2. 誰かが押したあと
            else {
                btn.disabled = true;
                btn.className = '';
                
                if (winner === myName) {
                    // ★ 自分が回答権を持っている時の表示分岐 ★
                    if (judgment === 'correct') {
                        // 正解の時
                        btn.style.background = "#ffcc00"; // 金色
                        btn.innerText = "⭕️";
                        status.style.color = "#e6ac00";
                        status.innerText = "正解！！";
                    } else if (judgment === 'incorrect') {
                        // 不正解の時
                        btn.style.background = "#3366ff"; // 青
                        btn.innerText = "❌";
                        status.style.color = "#3366ff";
                        status.innerText = "不正解...";
                    } else {
                        // まだ判定待ちの時
                        btn.style.background = "#ff3333"; // 赤
                        btn.innerText = "1着!!";
                        status.style.color = "#ff3333";
                        status.innerText = "判定待ち";
                    }
                } else if (winner) {
                    // 他の人が回答権を持っている時
                    btn.style.background = "#ccc";
                    btn.innerText = "LOCK";
                    status.style.color = "black";
                    status.innerText = winner + " が回答中";
                } else {
                    // リセット中
                    btn.style.background = "#ccc";
                    btn.innerText = "待機";
                    status.innerText = "出題待ち...";
                }
            }
        });

        btn.addEventListener('click', (e) => {
            e.preventDefault();
            ref.child('winner').transaction((current) => {
                return current === null ? myName : undefined;
            });
        });
    </script>
</body>
</html>
